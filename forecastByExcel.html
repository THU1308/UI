<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thủy điện Kon Tum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
    </style>
    <!-- Thêm thư viện jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Thêm thư viện PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Thêm thư viện xlsx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script>
        $(document).ready(function () {
            // Hàm để đọc file CSV
            function readCSV(file) {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    complete: function (results) {
                        console.log(results.data);
                        processData(results.data);
                    }
                });
            }

            // Hàm để đọc file XLSX
            function readXLSX(file) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, { type: 'array' });
                    var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    var jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    console.log(jsonData);
                    processData(jsonData);
                };
                reader.readAsArrayBuffer(file);
            }

            // Hàm để chuyển đổi giá trị thời gian của Excel thành ngày tháng năm
            function excelDateToJSDate(serial) {
                var utc_days = Math.floor(serial - 25569);
                var utc_value = utc_days * 86400;
                var date_info = new Date(utc_value * 1000);

                var fractional_day = serial - Math.floor(serial) + 0.0000001;

                var total_seconds = Math.floor(86400 * fractional_day);

                var seconds = total_seconds % 60;

                total_seconds -= seconds;

                var hours = Math.floor(total_seconds / (60 * 60));
                var minutes = Math.floor(total_seconds / 60) % 60;

                return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate(), hours, minutes, seconds);
            }

            // Định nghĩa lớp Record đại diện cho một bản ghi
            class Record {
                constructor(time, konPlongLuongMua, konTumLuongMua, mangCanhLuongMua, konPlongDongChay, konTumDongChay) {
                    this.time = time;
                    this.konPlongLuongMua = konPlongLuongMua;
                    this.konTumLuongMua = konTumLuongMua;
                    this.mangCanhLuongMua = mangCanhLuongMua;
                    this.konPlongDongChay = konPlongDongChay;
                    this.konTumDongChay = konTumDongChay;
                }

                // Phương thức để hiển thị bản ghi
                display() {
                    return `
            <tr>
                <td class="border px-4 py-2">${this.time}</td>
                <td class="border px-4 py-2">${this.konPlongLuongMua}</td>
                <td class="border px-4 py-2">${this.konTumLuongMua}</td>
                <td class="border px-4 py-2">${this.mangCanhLuongMua}</td>
                <td class="border px-4 py-2">${this.konPlongDongChay}</td>
                <td class="border px-4 py-2">${this.konTumDongChay}</td>
            </tr>
        `;
                }
            }

            // Hàm để xử lý dữ liệu và tạo các đối tượng Record
            // function processData(data) {
            //     // Kiểm tra và xử lý dữ liệu
            //     var records = [];
            //     var validRecords = []; // Mảng chứa các bản ghi hợp lệ (4 bản ghi liền kề với khoảng cách 6 tiếng)
            //     var invalidRecords = []; // Mảng chứa các bản ghi không hợp lệ

            //     for (var i = 1; i < data.length; i = i + 4) {
            //         var record1 = data[i];
            //         var record2 = data[i + 1];
            //         var record3 = data[i + 2];
            //         var record4 = data[i + 3];

            //         // Kiểm tra và bỏ qua các dòng trống
            //         if (!isValidRow(record1) || !isValidRow(record2) || !isValidRow(record3) || !isValidRow(record4)) {
            //             alert("Invalid file format!")
            //             return;
            //         }

            //         // Chuyển đổi thời gian từ Excel sang đối tượng Date
            //         var time1 = excelDateToJSDate(record1[0]);
            //         var time2 = excelDateToJSDate(record2[0]);
            //         var time3 = excelDateToJSDate(record3[0]);
            //         var time4 = excelDateToJSDate(record4[0]);

            //         // Tính khoảng cách thời gian giữa các bản ghi
            //         var diff1to2 = Math.abs(time2 - time1) / (1000 * 60 * 60); // Đổi ra giờ
            //         var diff2to3 = Math.abs(time3 - time2) / (1000 * 60 * 60); // Đổi ra giờ
            //         var diff3to4 = Math.abs(time4 - time3) / (1000 * 60 * 60); // Đổi ra giờ

            //         // Kiểm tra các bản ghi có đáp ứng yêu cầu khoảng cách 6 tiếng không
            //         if (diff1to2 >= 6 && diff2to3 >= 6 && diff3to4 >= 6) {
            //             // Nếu đúng yêu cầu, thêm vào mảng validRecords
            //             validRecords.push(record1, record2, record3, record4);
            //         } else {
            //             // Nếu không đúng yêu cầu, thêm vào mảng invalidRecords
            //             invalidRecords.push(record1, record2, record3, record4);
            //         }


            //     }

            //     // Hiển thị thông báo cho các bản ghi không hợp lệ (nếu có)
            //     if (invalidRecords.length > 0) {
            //         alert('Invalid date file format!');
            //         return;
            //     }

            //     // Xử lý và hiển thị các bản ghi hợp lệ
            //     validRecords.forEach(function (record) {
            //         var newRecord = new Record(
            //             excelDateToJSDate(record[0]),
            //             record[1],
            //             record[2],
            //             record[3],
            //             record[4],
            //             record[5]
            //         );
            //         records.push(newRecord);
            //     });
            //     // Hiển thị dữ liệu
            //     displayData(records);
            // }
            function processData(data) {
                var records = [];
                var validRecords = []; // Mảng chứa các bản ghi hợp lệ (4 bản ghi liền kề với khoảng cách 6 tiếng)
                var invalidRecords = []; // Mảng chứa các bản ghi không hợp lệ

                for (var i = 0; i < data.length - 3; i++) {
                    var record1 = data[i];
                    var record2 = data[i + 1];
                    var record3 = data[i + 2];
                    var record4 = data[i + 3];

                    // Kiểm tra dòng trống
                    if (!record1 || !record2 || !record3 || !record4) {
                        continue; // Nếu có dòng trống, bỏ qua
                    }

                    // Chuyển đổi thời gian từ CSV sang đối tượng Date
                    var time1 = excelDateToJSDate(record1[0]);
                    var time2 = excelDateToJSDate(record2[0]);
                    var time3 = excelDateToJSDate(record3[0]);
                    var time4 = excelDateToJSDate(record4[0]);

                    // Tính khoảng cách thời gian giữa các bản ghi
                    var diff1to2 = Math.abs(time2 - time1) / (1000 * 60 * 60); // Đổi ra giờ
                    var diff2to3 = Math.abs(time3 - time2) / (1000 * 60 * 60); // Đổi ra giờ
                    var diff3to4 = Math.abs(time4 - time3) / (1000 * 60 * 60); // Đổi ra giờ

                    // Kiểm tra các bản ghi có đáp ứng yêu cầu khoảng cách 6 tiếng không
                    if (diff1to2 >= 6 && diff2to3 >= 6 && diff3to4 >= 6) {
                        // Nếu đúng yêu cầu, thêm vào mảng validRecords
                        validRecords.push(record1, record2, record3, record4);
                        i += 3; // Bỏ qua các bản ghi đã xử lý
                    } else {
                        // Nếu không đúng yêu cầu, thêm vào mảng invalidRecords
                        invalidRecords.push(record1, record2, record3, record4);
                        i += 3; // Bỏ qua các bản ghi đã xử lý
                    }
                }

                // Hiển thị thông báo cho các bản ghi không hợp lệ (nếu có)
                if (invalidRecords.length > 0) {
                    alert('Invalid file format. Invalid records were ignored');
                }

                // Xử lý và hiển thị các bản ghi hợp lệ
                validRecords.forEach(function (record) {
                    var newRecord = new Record(
                        excelDateToJSDate(record[0]),
                        record[1],
                        record[2],
                        record[3],
                        record[4],
                        record[5]
                    );
                    records.push(newRecord);
                });

                // Hiển thị dữ liệu
                displayData(records);
            }



            function isValidRow(row) {
                // Kiểm tra dòng có tồn tại không
                if (!row) {
                    return false;
                }

                // Kiểm tra từng trường còn lại là số không âm
                for (var i = 1; i < row.length; i++) {
                    if (row[i] === null || row[i] === undefined || isNaN(row[i]) || row[i] < 0) {
                        return false;
                    }
                }

                // Nếu không có vấn đề gì, trả về true
                return true;
            }





            // Hàm để hiển thị dữ liệu lên trang web
            function displayData(records) {
                var table = '<div class="max-h-96 overflow-auto"><table class="table-auto w-full text-left">';
                table += '<thead><tr>';
                table += '<th class="px-4 py-2">Time</th>';
                table += '<th class="px-4 py-2">KonPlong_luongmua</th>';
                table += '<th class="px-4 py-2">KonTum_luongmua</th>';
                table += '<th class="px-4 py-2">Mang Canh_luongmua</th>';
                table += '<th class="px-4 py-2">KonPlong_dongchay</th>';
                table += '<th class="px-4 py-2">KonTum_dongchay</th>';
                table += '</tr></thead><tbody>';

                for (var i = 0; i < records.length; i++) {
                    table += records[i].display();
                }

                table += '</tbody></table></div>';
                $('#dataTable').html(table);
            }


            // Xử lý sự kiện khi chọn file
            $('#fileInput').change(function (event) {
                var file = event.target.files[0];
                var fileType = file.name.split('.').pop().toLowerCase();
                if (fileType === 'csv') {
                    readCSV(file);
                } else if (fileType === 'xlsx') {
                    readXLSX(file);
                } else {
                    alert('Please select a valid CSV or XLSX file.');
                }
            });
        });
    </script>
</head>

<body class="bg-gray-100 p-6">
    <div class="container mx-auto bg-white p-8 rounded shadow-lg">
        <h1 class="text-2xl font-bold mb-6 text-center text-blue-800">Hệ thống dự báo dòng chảy của lũ tại trạm Kon Tum
        </h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <img src="./Images/img1.jpg" alt="Hydropower Image 1" class="w-full h-auto rounded shadow-md">
            <img src="./Images/img2.jpg" alt="Hydropower Image 2" class="w-full h-auto rounded shadow-md">
        </div>

        <p class="text-center font-semibold text-gray-700">Trạm thủy điện Kon Tum</p>

        <button class="mt-6 w-full bg-green-500 text-white font-bold py-2 rounded hover:bg-green-600">Dự đoán</button>

        <!-- Input để chọn file CSV hoặc XLSX -->
        <div class="flex justify-center mt-6">
            <input type="file" id="fileInput" accept=".csv, .xlsx" class="bg-gray-200 p-2 rounded">
        </div>

        <div id="result" class="bg-sky-50 p-6 rounded-md border border-sky-200 shadow-md mt-6">
            <h2 class="text-lg font-bold text-sky-700">Kết quả dự báo</h2>
            <textarea id="calculatedResult" class="mt-4 p-2 border border-sky-300 rounded w-full h-32 font-extrabold" readonly>Có cái nịt</textarea>
        </div>

        <!-- Vùng để hiển thị dữ liệu -->
        <!-- <div id="dataTable" class="mt-6"></div> -->
    </div>
</body>

</html>